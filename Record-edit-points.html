<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Timekeeping Notepad with Stopwatch</title>
    <style>
      /* Basic page styling */
      body {
        margin: 0;
        padding: 20px;
        font-family: Arial, sans-serif;
        background: #f7f7f7;
      }
      
      h1 {
        text-align: center;
        color: #333;
      }
      
      /* Button styling */
      button {
        padding: 10px 20px;
        font-size: 1.1rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      #startButton {
        background-color: #007acc;
        color: #fff;
        margin-right: 10px;
      }
      #endButton {
        background-color: #d9534f;
        color: #fff;
      }
      /* Save button styled as a success button */
      #saveButton {
        background-color: #5cb85c;
        color: #fff;
        margin-left: 10px;
      }
      
      /* Stopwatch and the custom starting time input styling */
      #stopwatch {
        text-align: center;
        font-size: 2rem;
        margin: 20px 0;
        color: #007acc;
      }
      #startingContainer {
        text-align: center;
        margin-bottom: 10px;
      }
      #startingPoint {
        width: 100px;
        padding: 5px;
        font-size: 1rem;
        text-align: center;
      }
      
      /* Note input field styling */
      #noteInput {
        display: block;
        width: 80%;
        max-width: 600px;
        margin: 0 auto 20px auto;
        padding: 10px;
        font-size: 1.1rem;
        border: 1px solid #ccc;
        border-radius: 4px;
      }
      
      /* Container for recorded notes */
      #notes {
        width: 80%;
        max-width: 600px;
        margin: 0 auto;
      }
      
      .note {
        background: #fff;
        border: 1px solid #ddd;
        border-left: 5px solid #007acc;
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 3px;
      }
      
      .note .time {
        font-weight: bold;
        margin-right: 10px;
        color: #555;
      }
    </style>
  </head>
  <body>
    <h1>Timekeeping Notepad</h1>
    
    <!-- Container for custom starting time -->
    <div id="startingContainer">
      <label for="startingPoint">Starting Time (HH:MM:SS): </label>
      <input id="startingPoint" type="text" placeholder="00:00:00" />
    </div>
    
    <!-- Control Buttons -->
    <div style="text-align: center;">
      <button id="startButton">Start Recording</button>
      <button id="endButton" style="display: none;">End Recording</button>
      <button id="saveButton">Save</button>
    </div>
    
    <!-- Stopwatch display -->
    <div id="stopwatch">Stopwatch: 00:00:00</div>
    
    <!-- Note entry field -->
    <input id="noteInput" type="text" placeholder="Type your note and press Enter" disabled />
    
    <!-- Container for recorded notes -->
    <div id="notes"></div>
    
    <script>
      // Global state variables
      let isRecording = false;       // true when a session is active
      let recordingStart = null;     // system time when session began
      let startingOffset = 0;        // user-defined offset in milliseconds
      let stopwatchInterval = null;  // handle for setInterval
      let noteStartTime = null;      // stopwatch time when the first keystroke happens for a note
      
      // Helper function to format a duration (in ms) as HH:MM:SS
      function formatElapsed(ms) {
        const totalSeconds = Math.floor(ms / 1000);
        const seconds = totalSeconds % 60;
        const minutes = Math.floor(totalSeconds / 60) % 60;
        const hours = Math.floor(totalSeconds / 3600);
        return String(hours).padStart(2, '0') + ':' +
               String(minutes).padStart(2, '0') + ':' +
               String(seconds).padStart(2, '0');
      }
      
      // Update stopwatch display using the startingOffset and elapsed time from recordingStart
      function updateStopwatch() {
        const elapsed = Date.now() - recordingStart;
        const totalElapsed = startingOffset + elapsed;
        document.getElementById("stopwatch").textContent = "Stopwatch: " + formatElapsed(totalElapsed);
      }
      
      // START RECORDING: Begin a new recording session
      document.getElementById("startButton").addEventListener("click", function() {
        if (!isRecording) {
          // Try to parse user-specified starting time (expected format HH:MM:SS)
          let userStart = document.getElementById("startingPoint").value.trim();
          startingOffset = 0; // default offset is zero
          if (userStart !== "") {
            const parts = userStart.split(':');
            if (parts.length === 3) {
              const hours = parseInt(parts[0], 10);
              const minutes = parseInt(parts[1], 10);
              const seconds = parseInt(parts[2], 10);
              if (!isNaN(hours) && !isNaN(minutes) && !isNaN(seconds)) {
                startingOffset = ((hours * 3600) + (minutes * 60) + seconds) * 1000;
              }
            }
          }
          
          isRecording = true;
          recordingStart = Date.now();
          noteStartTime = null; // Clear any previous note start time
          
          // Set initial stopwatch display to the custom starting time
          document.getElementById("stopwatch").textContent = "Stopwatch: " + formatElapsed(startingOffset);
          stopwatchInterval = setInterval(updateStopwatch, 500);
          
          // Enable and focus the note input field
          const noteInput = document.getElementById("noteInput");
          noteInput.disabled = false;
          noteInput.value = "";
          noteInput.focus();
          
          // Update UI: hide the Start button, show the End button
          document.getElementById("startButton").style.display = "none";
          document.getElementById("endButton").style.display = "inline-block";
        }
      });
      
      // END RECORDING: Stop the current session
      document.getElementById("endButton").addEventListener("click", function() {
        if (isRecording) {
          isRecording = false;
          clearInterval(stopwatchInterval);
          
          // Optionally, reset the stopwatch display
          document.getElementById("stopwatch").textContent = "Stopwatch: 00:00:00";
          
          // Disable note input until a new session starts
          document.getElementById("noteInput").disabled = true;
          noteStartTime = null;
          
          // Update UI: show the Start button, hide the End button
          document.getElementById("startButton").style.display = "inline-block";
          document.getElementById("endButton").style.display = "none";
        }
      });
      
      // Capture the note's start time when the user begins typing
      const noteInput = document.getElementById("noteInput");
      noteInput.addEventListener("input", function() {
        if (noteInput.value.length > 0 && noteStartTime === null) {
          noteStartTime = formatElapsed(startingOffset + (Date.now() - recordingStart));
        } else if (noteInput.value.length === 0) {
          noteStartTime = null;
        }
      });
      
      // Add a note when the Enter key is pressed
      noteInput.addEventListener("keydown", function (event) {
        if (event.key === "Enter") {
          const noteText = noteInput.value.trim();
          if (noteText !== "") {
            if (!noteStartTime) {
              noteStartTime = formatElapsed(startingOffset + (Date.now() - recordingStart));
            }
            
            // Create a new note element with the captured stopwatch time and note text
            const noteDiv = document.createElement("div");
            noteDiv.className = "note";
            noteDiv.innerHTML =
              "<span class='time'>" + noteStartTime + ":</span>" +
              "<span class='text'>" + noteText + "</span>";
            
            // Insert the note at the beginning so that edit points are in descending order
            const notesContainer = document.getElementById("notes");
            notesContainer.insertBefore(noteDiv, notesContainer.firstChild);
            
            // Clear the input field and reset noteStartTime for the next note
            noteInput.value = "";
            noteStartTime = null;
          }
        }
      });
      
      // Save Button: Export notes as a text file
      document.getElementById("saveButton").addEventListener("click", function() {
        // Format the current date and time for the file header and filename
        function pad(num) {
          return num.toString().padStart(2, '0');
        }
        const now = new Date();
        const year = now.getFullYear();
        const month = pad(now.getMonth() + 1);
        const day = pad(now.getDate());
        const hours = pad(now.getHours());
        const minutes = pad(now.getMinutes());
        const formattedDateTime = year + "-" + month + "-" + day + " " + hours + ":" + minutes;
        
        let content = "# " + formattedDateTime + " edit point\n\n";
        
        // Get all recorded notes and reverse the order so that the file is in ascending order
        const notesNodeList = document.querySelectorAll("#notes .note");
        const notes = Array.from(notesNodeList).reverse();
        notes.forEach(function(noteElement) {
          let timeText = noteElement.querySelector(".time").textContent;
          if (timeText.endsWith(":")) {
            timeText = timeText.slice(0, -1);
          }
          const noteText = noteElement.querySelector(".text").textContent;
          content += timeText + "\n" + noteText + "\n\n";
        });
        
        // Trigger the file download using a Blob
        const blob = new Blob([content], { type: "text/plain" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        const safeFileNameDate = formattedDateTime.replace(" ", "_").replace(":", "-");
        a.href = url;
        a.download = "edit_points_" + safeFileNameDate + ".txt";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      });
    </script>
  </body>
</html>
